<!doctype html>
<html>
	<head>
	</head>
	<body>
		<h1>Chat with agent [<%= @id %>]</h1>
		<form id="chat">
			<input type="text" id="chat-input">
			<button type="submit">Send</button>
		</form>
		<div id="messages">
		</div>
	</body>
	<script src="/socket.io/socket.io.js"></script>
	<script>
	<!--
		var agent = '<%= @id %>';
		var socket = io();

		window.addEventListener('load', function() {
			var input = document.getElementById('chat-input');
			var container = document.getElementById('messages');

			// form
			document.getElementById('chat').addEventListener('submit', function(event) {
				event.preventDefault();

				var message = input.value;

				if (message) {
					socket.emit('message', {
						code: 'CHAT',
						data: {
							visitor: localStorage.visitor,
							agent: agent,
							chat: message
						}
					});

					input.value = '';
				}
			});

			// socket
			socket.on('connect', function() {
				console.log('connected', socket.id);

				if (!localStorage.visitor) {
					localStorage.visitor = Date.now();
				}

				socket.emit('message', {
					code: 'VISITOR_JOIN',
					data: {
						visitor: localStorage.visitor,
						agent: agent
					}
				});
			});

			socket.on('message', function(message) {
				if (message.code === 'CHAT') {
					append(container, message.data.chat);
				}
			});
		});

		function append(container, text) {
			var p = document.createElement('p');
			var n = document.createTextNode(text);

			p.appendChild(n);

			container.appendChild(p);
		}
	-->
	</script>
</html>
