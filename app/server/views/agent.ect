<!doctype html>
<html>
	<head>
	</head>
	<body>
		<h1>Agent [<%= @id %>]</h1>
	</body>
	<script src="/socket.io/socket.io.js"></script>
	<script>
	<!--
		var agent = '<%= @id %>';
		var socket = io();
		var conversations = {};

		window.addEventListener('load', function() {
			console.log('page loaded', agent);

			socket.on('connect', function() {

				socket.emit('message', {
					code: 'AGENT_JOIN',
					data: {
						agent: agent
					}
				});
			});

			socket.on('message', function(message) {
				if (message.code === 'CHAT') {
					console.log(message);

					createReplyForm(message.data.visitor);

					append(conversations[message.data.visitor], message.data.chat);
				}
			});
		});

		function append(container, text) {
			var p = document.createElement('p');
			var n = document.createTextNode(text);

			p.appendChild(n);

			container.appendChild(p);
		}

		function createReplyForm(visitor) {
			if (conversations[visitor]) {
				return;
			}

			var form = document.createElement('form');
			form.id = visitor;
			form.className = 'reply';

			var textbox = document.createElement('input');
			textbox.type = 'text';

			var button = document.createElement('button');
			button.type = 'submit';
			button.appendChild(document.createTextNode('Send'));

			var container = document.createElement('div');
			// container.id = 'conversation-' + visitor;

			form.appendChild(textbox);
			form.appendChild(button);
			form.appendChild(container);

			document.body.appendChild(form);

			conversations[visitor] = container;

			// bind event
			form.addEventListener('submit', function(event) {
				event.preventDefault();

				var message = textbox.value;

				if (message) {
					socket.emit('message', {
						code: 'CHAT',
						data: {
							visitor: visitor,
							agent: agent,
							chat: message
						}
					});

					textbox.value = '';
				}
			});
		}
	-->
	</script>
</html>
